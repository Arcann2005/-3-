# ticket-booking-system

## Описание

Данная система бронирования билетов включает в себя 2 вида API – для пользователей и администраторов. API пользователя позволяет:

- получать список всех сессий в системе
- получать список активных сессий в системе
- получить информацию о свободных местах на сеансе
- забронировать билет на сеанс
- отменить бронирование билета
- получить личную историю бронирования

Администраторский API позволяет:

- получить список всех пользователей в системе
- получить информацию по одному пользователю
- создавать/изменять/удалять пользователей
- наделять и лишать пользователя правами администратора
- создавать/изменять/удалять сессии и получать по ним информацию
- включать/отключать правило социальх льгот для пользователей

Настройки системы регулируются переменными окружения, объявленными в конфигурации:

- `SOCIAL_BENEFITS_ENABLE` – флаг, вкл./откл. правило социальных льгот для пользователей
- `STANDARD_CATEGORY_BOOKING_TIMEOUT` – кол-во минут до начала сеанса, по достижению которых пользователи с категорией _Standard_ могут забронировать билет
- `OCCUPANCY_TIMEOUT` – кол-во минут после создания сеанса, по достижению которых запускается проверка на необходимость открытия раннего доступа бронирования билетов для пользователей с категорией _Standard_
- `OCCUPANCY_MIN_RATE` – минимально необходимое кол-во забронированных билетов после достижения `OCCUPANCY_TIMEOUT` для открытия доступа к бронированию для всех категорий
- `OCCUPANCY_MAX_RATE` – максимально необходимое кол-во забронированных билетов после достижения `OCCUPANCY_TIMEOUT` для открытия доступа к бронированию для всех категорий
- `SOCIAL_ONE_DISCOUNT_PERCENTAGE` – скидка (в %) для пользователей с категорией _Social-1_
- `SOCIAL_TWO_DISCOUNT_PERCENTAGE` – скидка (в %) для пользователей с категорией _Social-2_
- `SOCIAL_THREE_DISCOUNT_PERCENTAGE` – скидка (в %) для пользователей с категорией _Social-3_

В системе также предусмотрен механизм, который совершает обход по всем активным сессиям на текущий момент и принимает решение об открытии доступа для бронирования для всех категорий при выполнении условий, описанных выше. По-умолчанию такая проверка осуществляется раз в минуту и регулируется _cron_-выражением.

### Баги

- [ ] Удаление сессии может вызвать исключение `ConstraintViolationException`
- [x] ~~Создание пользователя срабатывает при первой попытке, однако при последующих выбрасывается исключение `PersistentObjectException`. Перезапуск сервиса позволяет создать ещё одного пользователя так же только один раз. ¯\\_(ツ)_/¯~~
- [ ] При переносе сеанса администратором, дата начала сеанса в билете у пользователя не обновляется.
- [ ] Скорее всего возможны появления багов при переносе дат ДО текущего времени, при попытке создания даты начала МЕНЬШЕ чем дата создания или БОЛЬШЕ чем дата окончания сеанса и т.д. Всё это разруливается написанием тестов, но к _TDD_ я так пока и не пришёл.

### todo

- [ ] Генеральный рефакторинг. Есть повторяющийся код и длинные методы, например `bookTicket()` или `cancelBooking()`, которые, возможно, следует разнести на меньшие части.  
- [ ] Забросить тестовые данные в скрипты миграции.
- [ ] Упаковать в _docker-compose_.
- [ ] Тесты
- [ ] Тесты
- [ ] Тесты
